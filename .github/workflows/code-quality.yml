name: Code Quality Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  code-quality:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: test_vocabulary_db
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Wait for MySQL to be ready
      run: |
        echo "Waiting for MySQL to be ready..."
        while ! mysqladmin ping -h 127.0.0.1 -P 3306 -u root -ppassword --silent; do
          sleep 2
        done
        echo "MySQL is ready!"

    - name: Create test database
      run: |
        mysql -h 127.0.0.1 -P 3306 -u root -ppassword -e "CREATE DATABASE IF NOT EXISTS test_vocabulary_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"

    - name: Run Checkstyle
      run: |
        mvn checkstyle:check -Dcheckstyle.config.location=checkstyle.xml || true

    - name: Run SpotBugs static analysis
      run: |
        mvn spotbugs:check -Dspotbugs.effort=Max -Dspotbugs.threshold=Low || true

    - name: Run PMD analysis
      run: |
        mvn pmd:check -Dpmd.rulesets=rulesets/java/quickstart.xml || true

    - name: Compile with Maven
      run: mvn clean compile

    - name: Run unit tests
      run: mvn test
      env:
        SPRING_DATASOURCE_URL: jdbc:mysql://127.0.0.1:3306/test_vocabulary_db?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=UTC
        SPRING_DATASOURCE_USERNAME: root
        SPRING_DATASOURCE_PASSWORD: password

    - name: Generate test coverage report
      run: mvn jacoco:report

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./target/site/jacoco/jacoco.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

    - name: Run SonarCloud analysis
      run: |
        mvn sonar:sonar \
          -Dsonar.projectKey=vocabulary-app \
          -Dsonar.organization=wangjia15 \
          -Dsonar.host.url=https://sonarcloud.io \
          -Dsonar.java.binaries=target/classes \
          -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml \
          -Dsonar.junit.reportPaths=target/surefire-reports
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      continue-on-error: true

    - name: Dependency vulnerability scan
      run: mvn org.owasp:dependency-check-maven:check

    - name: Run OWASP dependency check summary
      run: |
        if [ -f "target/dependency-check-report.json" ]; then
          echo "## OWASP Dependency Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          jq -r '.dependencies[] | select(.vulnerabilities != null) | "- \(.name): \(.vulnerabilities | length) vulnerabilities"' target/dependency-check-report.json | head -10 >> $GITHUB_STEP_SUMMARY || echo "No vulnerabilities found" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Check code formatting with Google Java Format
      run: |
        mvn com.coveo:fmt-maven-plugin:format -Dstyle=google
        mvn com.coveo:fmt-maven-plugin:check -Dstyle=google

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          target/surefire-reports/
          target/site/jacoco/
          target/dependency-check-report.*

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: build-artifacts
        path: |
          target/*.jar
          target/classes/
          target/test-classes/

  security-scan:
    runs-on: ubuntu-latest
    needs: code-quality

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: 'trivy-results.sarif'

    - name: CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        languages: java

  build-check:
    runs-on: ubuntu-latest
    needs: [code-quality, security-scan]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    - name: Build application
      run: mvn clean package -DskipTests

    - name: Verify JAR was created
      run: |
        if [ -f "target/vocabulary-app-1.0.0.jar" ]; then
          echo "✅ Build successful - JAR file created"
          ls -la target/*.jar
        else
          echo "❌ Build failed - JAR file not found"
          exit 1
        fi

    - name: Check JAR file size
      run: |
        jar_size=$(stat -c%s "target/vocabulary-app-1.0.0.jar")
        echo "JAR file size: $jar_size bytes"
        if [ $jar_size -gt 52428800 ]; then
          echo "⚠️ Warning: JAR file is larger than 50MB"
        fi

  performance-check:
    runs-on: ubuntu-latest
    needs: build-check
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    - name: Build application
      run: mvn clean package -DskipTests

    - name: Run application performance test
      run: |
        timeout 30s java -jar target/vocabulary-app-1.0.0.jar &
        APP_PID=$!

        # Wait for application to start
        sleep 15

        # Check if application is responsive
        if curl -f http://localhost:8080/actuator/health 2>/dev/null; then
          echo "✅ Application started successfully"
        else
          echo "⚠️ Application may not have started properly"
        fi

        # Stop the application
        kill $APP_PID || true
      continue-on-error: true