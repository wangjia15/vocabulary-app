<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>背单词应用</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .word-card {
            transition: transform 0.2s;
            cursor: pointer;
        }
        .word-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .flip-card {
            background-color: transparent;
            width: 100%;
            height: 200px;
            perspective: 1000px;
        }
        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .flip-card.flipped .flip-card-inner {
            transform: rotateY(180deg);
        }
        .flip-card-front, .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .flip-card-front {
            background-color: #4CAF50;
            color: white;
        }
        .flip-card-back {
            background-color: #2196F3;
            color: white;
            transform: rotateY(180deg);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">背单词应用</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="#" id="loginBtn">登录</a>
                <a class="nav-link" href="#" id="registerBtn">注册</a>
                <a class="nav-link d-none" href="#" id="logoutBtn">退出</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- 统计信息 -->
        <div class="row mb-4" id="statsSection" style="display: none;">
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">今日复习</h5>
                        <h2 class="text-primary" id="todayReviews">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">正确率</h5>
                        <h2 class="text-success" id="correctRate">0%</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">待复习</h5>
                        <h2 class="text-warning" id="dueWords">0</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- 主要功能区域 -->
        <div class="row">
            <!-- 单词学习区 -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5>单词学习</h5>
                    </div>
                    <div class="card-body">
                        <div class="flip-card" id="wordCard">
                            <div class="flip-card-inner">
                                <div class="flip-card-front">
                                    <div>
                                        <h2 id="wordEnglish">点击开始学习</h2>
                                        <p id="wordPronunciation" class="mt-2"></p>
                                        <small>点击查看中文释义</small>
                                    </div>
                                </div>
                                <div class="flip-card-back">
                                    <div>
                                        <h3 id="wordChinese">释义</h3>
                                        <p id="wordExample" class="mt-2"></p>
                                        <small>点击返回英文</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-3" id="reviewButtons" style="display: none;">
                            <button class="btn btn-success me-2" onclick="reviewWord(true)">认识</button>
                            <button class="btn btn-danger" onclick="reviewWord(false)">不认识</button>
                        </div>

                        <div class="mt-3">
                            <button class="btn btn-primary" onclick="loadNextWord()">下一个单词</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 单词列表区 -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>单词列表</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <input type="text" class="form-control" id="searchInput" placeholder="搜索单词...">
                        </div>
                        <div class="mb-3">
                            <select class="form-select" id="categorySelect">
                                <option value="">所有分类</option>
                            </select>
                        </div>
                        <div id="wordList" style="max-height: 400px; overflow-y: auto;">
                            <!-- 单词列表将通过JavaScript动态加载 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 登录模态框 -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">登录</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label class="form-label">用户名</label>
                            <input type="text" class="form-control" name="username" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">密码</label>
                            <input type="password" class="form-control" name="password" required>
                        </div>
                        <button type="submit" class="btn btn-primary">登录</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 注册模态框 -->
    <div class="modal fade" id="registerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">注册</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="registerForm">
                        <div class="mb-3">
                            <label class="form-label">用户名</label>
                            <input type="text" class="form-control" name="username" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">邮箱</label>
                            <input type="email" class="form-control" name="email" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">密码</label>
                            <input type="password" class="form-control" name="password" required>
                        </div>
                        <button type="submit" class="btn btn-primary">注册</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentUser = null;
        let currentWord = null;
        let wordList = [];

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
            loadCategories();
            loadWordList();

            // 绑定事件
            document.getElementById('loginBtn').onclick = showLoginModal;
            document.getElementById('registerBtn').onclick = showRegisterModal;
            document.getElementById('logoutBtn').onclick = logout;
            document.getElementById('wordCard').onclick = flipCard;
            document.getElementById('searchInput').oninput = searchWords;
            document.getElementById('categorySelect').onchange = filterByCategory;
            document.getElementById('loginForm').onsubmit = login;
            document.getElementById('registerForm').onsubmit = register;
        });

        function checkLoginStatus() {
            const token = localStorage.getItem('token');
            if (token) {
                currentUser = true;
                updateUIForLoggedInUser();
            }
        }

        function updateUIForLoggedInUser() {
            document.getElementById('loginBtn').classList.add('d-none');
            document.getElementById('registerBtn').classList.add('d-none');
            document.getElementById('logoutBtn').classList.remove('d-none');
            document.getElementById('statsSection').style.display = 'block';
            loadStats();
            loadDueWords();
        }

        function showLoginModal() {
            new bootstrap.Modal(document.getElementById('loginModal')).show();
        }

        function showRegisterModal() {
            new bootstrap.Modal(document.getElementById('registerModal')).show();
        }

        function flipCard() {
            document.getElementById('wordCard').classList.toggle('flipped');
        }

        async function login(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const loginData = Object.fromEntries(formData);

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(loginData)
                });

                if (response.ok) {
                    const result = await response.json();
                    localStorage.setItem('token', result.token);
                    currentUser = true;
                    updateUIForLoggedInUser();
                    bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
                } else {
                    alert('登录失败');
                }
            } catch (error) {
                alert('登录失败: ' + error.message);
            }
        }

        async function register(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const registerData = Object.fromEntries(formData);

            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(registerData)
                });

                if (response.ok) {
                    const result = await response.json();
                    localStorage.setItem('token', result.token);
                    currentUser = true;
                    updateUIForLoggedInUser();
                    bootstrap.Modal.getInstance(document.getElementById('registerModal')).hide();
                } else {
                    alert('注册失败');
                }
            } catch (error) {
                alert('注册失败: ' + error.message);
            }
        }

        function logout() {
            localStorage.removeItem('token');
            currentUser = null;
            location.reload();
        }

        async function loadCategories() {
            try {
                const response = await fetch('/api/public/categories');
                const categories = await response.json();

                const select = document.getElementById('categorySelect');
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('加载分类失败:', error);
            }
        }

        async function loadWordList() {
            try {
                const response = await fetch('/api/public/words');
                wordList = await response.json();
                displayWordList(wordList);
            } catch (error) {
                console.error('加载单词列表失败:', error);
            }
        }

        function displayWordList(words) {
            const listContainer = document.getElementById('wordList');
            listContainer.innerHTML = '';

            words.forEach(word => {
                const wordCard = document.createElement('div');
                wordCard.className = 'card mb-2 word-card';
                wordCard.innerHTML = `
                    <div class="card-body">
                        <h6 class="card-title">${word.english}</h6>
                        <p class="card-text">${word.chinese}</p>
                    </div>
                `;
                wordCard.onclick = () => selectWord(word);
                listContainer.appendChild(wordCard);
            });
        }

        function selectWord(word) {
            currentWord = word;
            document.getElementById('wordEnglish').textContent = word.english;
            document.getElementById('wordPronunciation').textContent = word.pronunciation || '';
            document.getElementById('wordChinese').textContent = word.chinese;
            document.getElementById('wordExample').textContent = word.exampleSentence || '';

            // 重置卡片状态
            document.getElementById('wordCard').classList.remove('flipped');
            document.getElementById('reviewButtons').style.display = currentUser ? 'block' : 'none';
        }

        function loadNextWord() {
            if (wordList.length > 0) {
                const randomIndex = Math.floor(Math.random() * wordList.length);
                selectWord(wordList[randomIndex]);
            }
        }

        async function reviewWord(isCorrect) {
            if (!currentWord || !currentUser) return;

            try {
                const response = await fetch(`/api/learning/review/${currentWord.id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        isCorrect: isCorrect,
                        responseTime: 1
                    })
                });

                if (response.ok) {
                    loadStats();
                    loadNextWord();
                }
            } catch (error) {
                console.error('复习失败:', error);
            }
        }

        function searchWords() {
            const keyword = document.getElementById('searchInput').value.toLowerCase();
            const filtered = wordList.filter(word =>
                word.english.toLowerCase().includes(keyword) ||
                word.chinese.includes(keyword)
            );
            displayWordList(filtered);
        }

        function filterByCategory() {
            const categoryId = document.getElementById('categorySelect').value;
            if (categoryId) {
                // 这里应该调用API获取特定分类的单词
                // 临时实现：假设wordList中有categoryId字段
                const filtered = wordList.filter(word => word.categoryId == categoryId);
                displayWordList(filtered);
            } else {
                displayWordList(wordList);
            }
        }

        async function loadStats() {
            if (!currentUser) return;

            try {
                const response = await fetch('/api/learning/stats', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('todayReviews').textContent = stats.todayReviews;
                    document.getElementById('correctRate').textContent = stats.correctRate + '%';
                    document.getElementById('dueWords').textContent = stats.dueWordsCount;
                }
            } catch (error) {
                console.error('加载统计信息失败:', error);
            }
        }

        async function loadDueWords() {
            if (!currentUser) return;

            try {
                const response = await fetch('/api/learning/due', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    const dueWords = await response.json();
                    if (dueWords.length > 0) {
                        selectWord(dueWords[0]);
                    } else {
                        loadNextWord();
                    }
                }
            } catch (error) {
                console.error('加载待复习单词失败:', error);
                loadNextWord();
            }
        }
    </script>
</body>
</html>